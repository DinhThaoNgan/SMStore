@page "{id:int}"
@model OrdersDetailModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = $"Chi ti·∫øt ƒë∆°n h√†ng #{Model.Order.Id}";

    var customer = Model.Order.ApplicationUser;
    var totalOriginal = Model.Order.OrderDetails.Sum(x => x.Price * x.Quantity);
    var discount = Model.Order.DiscountAmount;
    var finalTotal = totalOriginal - discount;
}

<div class="container py-5">
    <h2 class="mb-4 fw-bold text-primary">
        <i class="bi bi-receipt-cutoff me-2"></i> Chi ti·∫øt ƒë∆°n h√†ng #@Model.Order.Id
    </h2>

    <!-- Th√¥ng tin kh√°ch h√†ng -->
    <div class="row mb-4">
        <div class="col-md-6">
            <p>
                <i class="bi bi-person-circle me-1"></i> <strong>Kh√°ch h√†ng:</strong>
                @(
                                string.IsNullOrWhiteSpace(Model.Order.CustomerName)
                                ? (string.IsNullOrWhiteSpace(customer?.FullName)
                                ? customer?.UserName ?? "Kh√¥ng r√µ"
                                : customer.FullName)
                                : Model.Order.CustomerName
                                )
            </p>

            <p>
                <i class="bi bi-telephone me-1"></i> <strong>SƒêT:</strong>
                @(string.IsNullOrWhiteSpace(Model.Order.PhoneNumber)
                                ? (customer?.PhoneNumber ?? "Kh√¥ng r√µ")
                                : Model.Order.PhoneNumber)
            </p>

            <p>
                <i class="bi bi-clock me-1"></i> <strong>Ng√†y ƒë·∫∑t:</strong>
                @Model.Order.OrderDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
            </p>
        </div>

        <div class="col-md-6">
            <p>
                <i class="bi bi-geo-alt me-1"></i> <strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong>
                @Model.Order.ShippingAddress
            </p>

            <p>
                <i class="bi bi-stickies me-1"></i> <strong>Ghi ch√∫:</strong>
                @(string.IsNullOrWhiteSpace(Model.Order.Notes) ? "Kh√¥ng" : Model.Order.Notes)
            </p>

            <p>
                <i class="bi bi-ticket-perforated me-1"></i> <strong>M√£ khuy·∫øn m√£i:</strong>
                @(string.IsNullOrWhiteSpace(Model.Order.CouponCode) ? "Kh√¥ng" : Model.Order.CouponCode)
            </p>

            <p>
                <i class="bi bi-cash-stack me-1"></i> <strong>Ti·ªÅn ƒë∆∞·ª£c gi·∫£m:</strong>
                @($"{discount:N0} VND")
            </p>
        </div>
    </div>

    <!-- Tr·∫°ng th√°i ƒë∆°n h√†ng -->
    <div class="mb-4">
        <h5><i class="bi bi-info-circle me-1"></i> Tr·∫°ng th√°i ƒë∆°n h√†ng</h5>
        <div class="text-muted">
            <i class="bi bi-lock-fill"></i> Tr·∫°ng th√°i hi·ªán t·∫°i: <strong>@Model.Order.Status</strong>
        </div>
    </div>

    <hr />

    <h5 class="mb-3"><i class="bi bi-box-seam me-1"></i> Danh s√°ch s·∫£n ph·∫©m</h5>
    <div class="table-responsive shadow-sm rounded">
        <table class="table align-middle table-bordered">
            <thead class="table-light text-center">
                <tr>
                    <th>S·∫£n ph·∫©m</th>
                    <th>H√¨nh ·∫£nh</th>
                    <th>Phi√™n b·∫£n</th>
                    <th>Ph√¢n lo·∫°i</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>Th√†nh ti·ªÅn</th>
                </tr>
            </thead>
            <tbody class="text-center">
                @foreach (var item in Model.Order.OrderDetails)
                {
                    var imgUrl = string.IsNullOrEmpty(item.ImageUrl)
                    ? Url.Content("~/images/no-image.png")
                    : item.ImageUrl;

                    <tr>
                        <td class="text-start">@item.Product?.Name</td>
                        <td>
                            <img src="@imgUrl" alt="·∫¢nh" class="img-thumbnail mx-auto d-block" style="max-width: 80px;" />
                        </td>
                        <td>@item.Color</td>
                        <td>@item.Size</td>
                        <td>@item.Quantity</td>
                        <td>@($"{item.Price:N0} VND")</td>
                        <td>@($"{item.Price * item.Quantity:N0} VND")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="text-end fs-5 fw-bold mt-4">
        <p><i class="bi bi-cash-coin me-1"></i> T·∫°m t√≠nh: @($"{totalOriginal:N0} VND")</p>
        <p><i class="bi bi-ticket-perforated me-1"></i> Gi·∫£m gi√°: -@($"{discount:N0} VND")</p>
        <p class="text-primary">
            <i class="bi bi-calculator me-1"></i> T·ªïng c·ªông thanh to√°n: @($"{finalTotal:N0} VND")
        </p>
    </div>

    <div class="mt-4 d-flex justify-content-between">
        <a asp-page="../Orders" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i> Quay l·∫°i
        </a>

        <div>
            @if (Model.Order.Status == "ƒê√£ ho√†n th√†nh")
            {
                <a asp-area="" asp-controller="Orders" asp-action="Print" asp-route-id="@Model.Order.Id" class="btn btn-primary">
                    üñ®Ô∏è In h√≥a ƒë∆°n
                </a>
            }

            <form method="post" asp-page-handler="Cancel" asp-route-id="@Model.Order.Id">
                <button type="submit"
                        class="btn btn-danger"
                        onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?');"
                        @(Model.Order.Status == "ƒêang giao h√†ng" || Model.Order.Status == "ƒê√£ ho√†n th√†nh" || Model.Order.Status == "ƒê√£ h·ªßy" ? "disabled" : "")>
                    ‚ùå H·ªßy ƒë∆°n h√†ng
                </button>
            </form>
        </div>
    </div>
</div>