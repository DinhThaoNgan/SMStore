@model CuaHangBanSach.Models.Order
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Chi ti·∫øt ƒë∆°n h√†ng";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

    var customer = Model.ApplicationUser;
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<div class="container py-5">
    <h2 class="mb-4 fw-bold">
        <i class="bi bi-receipt-cutoff me-2"></i> Chi ti·∫øt ƒë∆°n h√†ng #@Model.Id
    </h2>

    <div class="row mb-4">
        <div class="col-md-6">
            <p>
                <strong>Kh√°ch h√†ng:</strong>
                @(string.IsNullOrWhiteSpace(Model.CustomerName)
                                ? (string.IsNullOrWhiteSpace(customer?.FullName) ? customer?.UserName ?? "Kh√¥ng r√µ" : customer.FullName)
                                : Model.CustomerName)
            </p>

            <p>
                <strong>SƒêT:</strong>
                @(string.IsNullOrWhiteSpace(Model.PhoneNumber)
                                ? (string.IsNullOrWhiteSpace(customer?.PhoneNumber) ? "Kh√¥ng r√µ" : customer.PhoneNumber)
                                : Model.PhoneNumber)
            </p>

            <p><strong>Ng√†y ƒë·∫∑t:</strong> @Model.OrderDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
        </div>

        <div class="col-md-6">
            <p><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> @Model.ShippingAddress</p>
            <p><strong>Ghi ch√∫:</strong> @(string.IsNullOrWhiteSpace(Model.Notes) ? "Kh√¥ng" : Model.Notes)</p>
            <p><strong>M√£ khuy·∫øn m√£i:</strong> @(string.IsNullOrWhiteSpace(Model.CouponCode) ? "Kh√¥ng" : Model.CouponCode)</p>
            <p><strong>Ti·ªÅn ƒë∆∞·ª£c gi·∫£m:</strong> @($"{Model.DiscountAmount:N0} VND")</p>
        </div>
    </div>

    <div class="mb-4">
        <h5><i class="bi bi-info-circle me-1"></i> Tr·∫°ng th√°i ƒë∆°n h√†ng</h5>

        @{
            var options = new List<SelectListItem>
                {
                new SelectListItem { Text = "ƒêang x·ª≠ l√Ω", Value = "ƒêang x·ª≠ l√Ω" },
                new SelectListItem { Text = "ƒê√£ x·ª≠ l√Ω", Value = "ƒê√£ x·ª≠ l√Ω" },
                new SelectListItem { Text = "ƒêang giao h√†ng", Value = "ƒêang giao h√†ng" },
                new SelectListItem { Text = "ƒê√£ ho√†n th√†nh", Value = "ƒê√£ ho√†n th√†nh" },
                new SelectListItem { Text = "ƒê√£ h·ªßy", Value = "ƒê√£ h·ªßy" }
                };

            if (Model.Status == "ƒêang giao h√†ng")
            {
                options.RemoveAll(o => o.Value == "ƒê√£ h·ªßy");
            }
            else if (Model.Status == "ƒê√£ ho√†n th√†nh" || Model.Status == "ƒê√£ h·ªßy")
            {
                options.Clear();
            }
        }

        @if (options.Any())
        {
            <form asp-action="UpdateStatus" method="post" class="d-flex gap-3 align-items-center">
                <input type="hidden" name="orderId" value="@Model.Id" />
                @Html.DropDownList("status", new SelectList(options, "Value", "Text", Model.Status),
                new { @class = "form-select w-auto", onchange = "this.form.submit()" })
            <span class="text-muted">(T·ª± ƒë·ªông l∆∞u khi ch·ªçn)</span>
        </form>
                }
        else
        {
            <div class="text-muted">
                <i class="bi bi-lock-fill"></i> Tr·∫°ng th√°i hi·ªán t·∫°i:
                <strong>@Model.Status</strong> (kh√¥ng th·ªÉ thay ƒë·ªïi)
            </div>
        }
    </div>

    <hr />
    <h5 class="mb-3"><i class="bi bi-box-seam me-1"></i> Danh s√°ch s·∫£n ph·∫©m</h5>

    <div class="table-responsive shadow-sm rounded">
        <table class="table align-middle table-bordered">
            <thead class="table-light text-center">
                <tr>
                    <th>S·∫£n ph·∫©m</th>
                    <th>H√¨nh ·∫£nh</th>
                    <th>Phi√™n b·∫£n</th>
                    <th>Ph√¢n lo·∫°i</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>Th√†nh ti·ªÅn</th>
                </tr>
            </thead>
            <tbody class="text-center">
                @foreach (var item in Model.OrderDetails)
                {
                    var imgUrl = string.IsNullOrEmpty(item.ImageUrl)
                    ? Url.Content("~/images/no-image.png")
                    : item.ImageUrl;

                    <tr>
                        <td class="text-start">@item.Product?.Name</td>
                        <td>
                            <img src="@imgUrl" alt="·∫¢nh"
                                 class="img-thumbnail mx-auto d-block"
                                 style="max-width: 80px;" />
                        </td>
                        <td>@item.Color</td>
                        <td>@item.Size</td>
                        <td>@item.Quantity</td>
                        <td>@($"{item.Price:N0} VND")</td>
                        <td>@($"{item.Price * item.Quantity:N0} VND")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="text-end fs-5 fw-bold mt-4">
        @{
            var totalOriginal = Model.OrderDetails.Sum(x => x.Price * x.Quantity);
            var discount = Model.DiscountAmount;
            var finalTotal = totalOriginal - discount;
        }

        <p><i class="bi bi-cash-coin me-1"></i> T·∫°m t√≠nh: @($"{totalOriginal:N0} VND")</p>
        <p><i class="bi bi-ticket-perforated me-1"></i> Gi·∫£m gi√°: -@($"{discount:N0} VND")</p>
        <p class="text-primary"><i class="bi bi-calculator me-1"></i> T·ªïng c·ªông thanh to√°n: @($"{finalTotal:N0} VND")</p>
    </div>

    @if (Model.Status == "ƒê√£ ho√†n th√†nh")
    {
        <a asp-action="Print" asp-route-id="@Model.Id" target="_blank" class="btn btn-primary me-2">
            üñ®Ô∏è In h√≥a ƒë∆°n
        </a>
    }

    <div class="mt-4">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i> Quay v·ªÅ danh s√°ch
        </a>
    </div>
</div>