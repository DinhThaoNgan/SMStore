@model CuaHangBanSach.Models.Product
@using System.Text.Json

@{
    ViewData["Title"] = "Chi tiết sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

    var simpleVariants = Model.Variants?.Select(v => new {
        color = v.Color,
        size = v.Size,
        stockQuantity = v.StockQuantity,
        imageUrl = v.ImageUrl
    });

    var allImages = new List<string>();
    if (!string.IsNullOrEmpty(Model.ImageUrl)) allImages.Add(Model.ImageUrl);
    if (Model.Variants != null)
    {
        allImages.AddRange(Model.Variants
            .Where(v => !string.IsNullOrEmpty(v.ImageUrl))
            .Select(v => v.ImageUrl!));
    }
}

<div class="container py-4">
    <div class="row">
        <div class="col-md-6 text-center">
            <img id="mainImage" src="@Model.ImageUrl" class="img-fluid border mb-3" style="max-height: 350px; object-fit: contain;" />

            <div class="d-flex flex-wrap justify-content-center gap-2 mt-2">
                @foreach (var img in allImages.Distinct())
                {
                    <img src="@img" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;" onclick="setMainImage('@img')" />
                }
            </div>
        </div>
        <div class="col-md-6">
            <h3>@Model.Name</h3>
            <p class="text-muted">@Model.Description</p>
            <p><strong>Giá:</strong> @string.Format("{0:N0} VND", Model.Price)</p>
            <p><strong>Thể loại :</strong> @Model.Category?.Name</p>
            <p><strong>Nhà xuất bản:</strong> @Model.Brand?.Name</p>

            @if (Model.Variants != null && Model.Variants.Any())
            {
                <hr />
                <h5>Chọn phiên bản:</h5>
                <div class="mb-3 d-flex flex-wrap gap-2" id="colorOptions">
                    @foreach (var color in Model.Variants.Select(v => v.Color).Distinct())
                    {
                        <button type="button" class="btn btn-outline-dark variant-color" data-color="@color">@color</button>
                    }
                </div>

                <h5>Chọn phân loại:</h5>
                <div class="mb-3 d-flex flex-wrap gap-2" id="sizeOptions">
                    @foreach (var size in Model.Variants.Select(v => v.Size).Distinct())
                    {
                        <button type="button" class="btn btn-outline-secondary variant-size" data-size="@size">@size</button>
                    }
                </div>

                <div id="stockInfo" class="mt-2 fw-bold text-primary"></div>
                <div id="variantError" class="text-danger small"></div>
            }

            <div class="mt-4">
                <a asp-action="Index" asp-area="Admin" class="btn btn-secondary">← Quay lại</a>
                <a asp-action="Update" asp-area="Admin" asp-route-id="@Model.Id" class="btn btn-warning ms-2">✏️ Chỉnh sửa</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const variants = @Html.Raw(JsonSerializer.Serialize(simpleVariants));
        let selectedColor = null;
        let selectedSize = null;

        function setMainImage(url) {
            document.getElementById("mainImage").src = url;
        }

        function resetToDefault() {
            setMainImage('@Model.ImageUrl');
            document.getElementById('stockInfo').innerText = "";
            document.getElementById('variantError').innerText = "";
        }

        function updateDisplay() {
            const stockInfo = document.getElementById('stockInfo');
            const errorInfo = document.getElementById('variantError');

            if (!selectedColor || !selectedSize) {
                resetToDefault();
                return;
            }

            const matched = variants.find(v => v.color === selectedColor && v.size === selectedSize);
            if (matched) {
                if (matched.imageUrl)
                    setMainImage(matched.imageUrl);
                else
                    setMainImage('@Model.ImageUrl');

                stockInfo.innerText = "Tồn kho: " + matched.stockQuantity;
                errorInfo.innerText = "";
            } else {
                setMainImage('@Model.ImageUrl');
                stockInfo.innerText = "";
                errorInfo.innerText = "❌ Không tìm thấy biến thể phù hợp.";
            }
        }

        function updateButtons(className, selectedValue) {
            document.querySelectorAll('.' + className).forEach(btn => {
                btn.classList.remove('active', 'btn-dark', 'btn-primary');
                btn.classList.add('btn-outline-' + (className === 'variant-color' ? 'dark' : 'secondary'));
                if (btn.getAttribute('data-' + className.split('-')[1]) === selectedValue) {
                    btn.classList.remove('btn-outline-' + (className === 'variant-color' ? 'dark' : 'secondary'));
                    btn.classList.add('active', className === 'variant-color' ? 'btn-dark' : 'btn-primary');
                }
            });
        }

        document.querySelectorAll('.variant-color').forEach(btn => {
            btn.addEventListener('click', function () {
                const color = this.getAttribute('data-color');
                selectedColor = (selectedColor === color) ? null : color;
                updateButtons('variant-color', selectedColor);
                updateDisplay();
            });
        });

        document.querySelectorAll('.variant-size').forEach(btn => {
            btn.addEventListener('click', function () {
                const size = this.getAttribute('data-size');
                selectedSize = (selectedSize === size) ? null : size;
                updateButtons('variant-size', selectedSize);
                updateDisplay();
            });
        });
    </script>
}